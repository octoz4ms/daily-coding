<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.octo.eum.mapper.RoleMapper">

    <!-- 角色结果映射（包含权限） -->
    <resultMap id="RoleWithPermissionsResultMap" type="com.octo.eum.entity.Role">
        <id column="id" property="id"/>
        <result column="code" property="code"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="sort" property="sort"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="deleted" property="deleted"/>
        <collection property="permissions" ofType="com.octo.eum.entity.Permission">
            <id column="perm_id" property="id"/>
            <result column="perm_parent_id" property="parentId"/>
            <result column="perm_code" property="code"/>
            <result column="perm_name" property="name"/>
            <result column="perm_type" property="type"/>
            <result column="perm_path" property="path"/>
            <result column="perm_component" property="component"/>
            <result column="perm_icon" property="icon"/>
            <result column="perm_sort" property="sort"/>
            <result column="perm_visible" property="visible"/>
            <result column="perm_status" property="status"/>
        </collection>
    </resultMap>

    <!-- 根据用户ID查询角色列表 -->
    <select id="selectByUserId" resultType="com.octo.eum.entity.Role">
        SELECT r.*
        FROM sys_role r
                 INNER JOIN sys_user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND r.deleted = 0
          AND r.status = 1
        ORDER BY r.sort ASC
    </select>

    <!-- 根据角色ID查询角色（包含权限） -->
    <select id="selectRoleWithPermissions" resultMap="RoleWithPermissionsResultMap">
        SELECT r.*,
               p.id        AS perm_id,
               p.parent_id AS perm_parent_id,
               p.code      AS perm_code,
               p.name      AS perm_name,
               p.type      AS perm_type,
               p.path      AS perm_path,
               p.component AS perm_component,
               p.icon      AS perm_icon,
               p.sort      AS perm_sort,
               p.visible   AS perm_visible,
               p.status    AS perm_status
        FROM sys_role r
                 LEFT JOIN sys_role_permission rp ON r.id = rp.role_id
                 LEFT JOIN sys_permission p ON rp.permission_id = p.id AND p.deleted = 0
        WHERE r.id = #{roleId}
          AND r.deleted = 0
    </select>

</mapper>

