# ç§’æ€ç³»ç»Ÿ (Seckill System)

> ğŸ”¥ é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿ - é¢è¯•äº®ç‚¹é¡¹ç›®

## ğŸ“Œ æ ¸å¿ƒæŠ€æœ¯ç‚¹

| æŠ€æœ¯ç‚¹ | å®ç°æ–¹æ¡ˆ | è¯´æ˜ |
|-------|---------|------|
| Redisç¼“å­˜é¢„çƒ­ | `StockCacheService.warmUpStock()` | åº”ç”¨å¯åŠ¨æ—¶å°†åº“å­˜åŠ è½½åˆ°Redis |
| åˆ†å¸ƒå¼é” | Redisson | é˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤ç§’æ€ |
| æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³° | RabbitMQ | å¼‚æ­¥å¤„ç†è®¢å•ï¼Œå‰Šå‡æ•°æ®åº“å‹åŠ› |
| é™æµé™çº§ | Guava RateLimiter | ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ³¨è§£å¼é™æµ |
| åº“å­˜è¶…å– | ä¸‰å±‚é˜²æŠ¤æœºåˆ¶ | Redis Lua + ä¹è§‚é” + å”¯ä¸€ç´¢å¼• |

## ğŸ¯ é¢è¯•å¿…é—®ï¼šå¦‚ä½•ä¿è¯åº“å­˜ä¸è¶…å–ï¼Ÿ

### ä¸‰å±‚é˜²æŠ¤æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¬¬ä¸€å±‚ï¼šRedis Luaè„šæœ¬                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  if stock > 0 then DECR else return 0              â”‚   â”‚
â”‚  â”‚  åŸå­æ“ä½œï¼Œä¿è¯ä¸ä¼šå‡ºç°è´Ÿåº“å­˜                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     ç¬¬äºŒå±‚ï¼šæ•°æ®åº“ä¹è§‚é”                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  UPDATE ... WHERE available_stock > 0              â”‚   â”‚
â”‚  â”‚  å³ä½¿Redisæ•°æ®ä¸ä¸€è‡´ï¼Œæ•°æ®åº“ä¹Ÿèƒ½å…œåº•                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     ç¬¬ä¸‰å±‚ï¼šå”¯ä¸€ç´¢å¼•                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  UNIQUE INDEX (user_id, activity_id)               â”‚   â”‚
â”‚  â”‚  é˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤ä¸‹å•                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç 

```java
// Redis Luaè„šæœ¬ - åŸå­é¢„æ‰£å‡
private static final String DEDUCT_STOCK_SCRIPT = 
    "local stock = redis.call('GET', KEYS[1]) " +
    "if stock and tonumber(stock) > 0 then " +
    "    redis.call('DECR', KEYS[1]) " +
    "    return 1 " +
    "else " +
    "    return 0 " +
    "end";

// æ•°æ®åº“ä¹è§‚é”æ‰£å‡
@Update("UPDATE t_seckill_activity SET available_stock = available_stock - 1 " +
        "WHERE id = #{activityId} AND available_stock > 0")
int deductStock(@Param("activityId") Long activityId);
```

## ğŸ”„ ç§’æ€æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥å£é™æµ     â”‚ â† ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆ1000/sï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ´»åŠ¨çŠ¶æ€æ ¡éªŒ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†å¸ƒå¼é”      â”‚ â† Redissonï¼ˆé˜²é‡å¤ç§’æ€ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ ¡éªŒ     â”‚ â† Redis + DB åŒé‡æ£€æŸ¥
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redisé¢„æ‰£åº“å­˜ â”‚ â† Luaè„šæœ¬åŸå­æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é€MQæ¶ˆæ¯   â”‚ â† å¼‚æ­¥å‰Šå³°
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›æ’é˜Ÿä¸­   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
        â•‘ å¼‚æ­¥
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQæ¶ˆè´¹è€…     â”‚
â”‚  â”œâ”€ å¹‚ç­‰æ ¡éªŒ   â”‚
â”‚  â”œâ”€ DBæ‰£åº“å­˜  â”‚ â† ä¹è§‚é”
â”‚  â””â”€ åˆ›å»ºè®¢å•  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
seckill-system/
â”œâ”€â”€ src/main/java/com/octo/seckill/
â”‚   â”œâ”€â”€ SeckillApplication.java        # å¯åŠ¨ç±»
â”‚   â”œâ”€â”€ annotation/
â”‚   â”‚   â””â”€â”€ RateLimit.java             # é™æµæ³¨è§£
â”‚   â”œâ”€â”€ aspect/
â”‚   â”‚   â””â”€â”€ RateLimitAspect.java       # é™æµåˆ‡é¢
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ Result.java                # ç»Ÿä¸€å“åº”
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ RabbitMQConfig.java        # MQé…ç½®
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ SeckillController.java     # ç§’æ€æ¥å£
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ SeckillRequest.java        # è¯·æ±‚DTO
â”‚   â”‚   â””â”€â”€ SeckillMessage.java        # MQæ¶ˆæ¯
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ Product.java               # å•†å“
â”‚   â”‚   â”œâ”€â”€ SeckillActivity.java       # ç§’æ€æ´»åŠ¨
â”‚   â”‚   â””â”€â”€ SeckillOrder.java          # ç§’æ€è®¢å•
â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â”œâ”€â”€ ProductMapper.java
â”‚   â”‚   â”œâ”€â”€ SeckillActivityMapper.java
â”‚   â”‚   â””â”€â”€ SeckillOrderMapper.java
â”‚   â”œâ”€â”€ mq/
â”‚   â”‚   â”œâ”€â”€ SeckillMessageProducer.java # MQç”Ÿäº§è€…
â”‚   â”‚   â””â”€â”€ SeckillMessageConsumer.java # MQæ¶ˆè´¹è€…
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ SeckillService.java         # ç§’æ€æ ¸å¿ƒæœåŠ¡
â”‚       â”œâ”€â”€ StockCacheService.java      # åº“å­˜ç¼“å­˜æœåŠ¡
â”‚       â””â”€â”€ DistributedLockService.java # åˆ†å¸ƒå¼é”æœåŠ¡
â””â”€â”€ src/main/resources/
    â”œâ”€â”€ application.yml
    â””â”€â”€ db/schema.sql
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. ç¯å¢ƒè¦æ±‚

- JDK 17+
- MySQL 8.0+
- Redis 6.0+
- RabbitMQ 3.x

### 2. åˆå§‹åŒ–æ•°æ®åº“

```bash
mysql -u root -p < src/main/resources/db/schema.sql
```

### 3. ä¿®æ”¹é…ç½®

ç¼–è¾‘ `application.yml`ï¼Œä¿®æ”¹æ•°æ®åº“ã€Redisã€RabbitMQè¿æ¥ä¿¡æ¯ã€‚

### 4. å¯åŠ¨åº”ç”¨

```bash
mvn spring-boot:run
```

## ğŸ“¡ APIæ¥å£

### æ‰§è¡Œç§’æ€

```bash
POST /api/seckill/do
Content-Type: application/json

{
  "userId": 10001,
  "activityId": 1
}
```

### æŸ¥è¯¢ç»“æœ

```bash
GET /api/seckill/result?userId=10001&activityId=1
```

### æŸ¥è¯¢åº“å­˜

```bash
GET /api/seckill/stock/1
```

## ğŸ” é¢è¯•å¸¸è§è¿½é—®

### 1. ä¸ºä»€ä¹ˆç”¨Redis Luaè„šæœ¬è€Œä¸æ˜¯å…ˆGETå†DECRï¼Ÿ

**é—®é¢˜**ï¼šå…ˆGETåˆ¤æ–­åº“å­˜ï¼Œå†DECRæ‰£å‡ï¼Œä¸æ˜¯åŸå­æ“ä½œã€‚é«˜å¹¶å‘ä¸‹å¯èƒ½å¤šä¸ªè¯·æ±‚åŒæ—¶è¯»åˆ°åº“å­˜>0ï¼Œå¯¼è‡´è¶…å–ã€‚

**æ–¹æ¡ˆ**ï¼šLuaè„šæœ¬ä¿è¯åˆ¤æ–­å’Œæ‰£å‡æ˜¯åŸå­æ“ä½œã€‚

### 2. ä¸ºä»€ä¹ˆç”¨MQå‰Šå³°ï¼Ÿ

**é—®é¢˜**ï¼šç§’æ€ç¬é—´æ•°æ®åº“æ‰›ä¸ä½ã€‚

**æ–¹æ¡ˆ**ï¼š
- è¯·æ±‚å…ˆé¢„æ‰£Redisåº“å­˜ï¼Œå‘MQæ¶ˆæ¯åç«‹å³è¿”å›
- MQæ¶ˆè´¹è€…åŒ€é€Ÿæ¶ˆè´¹ï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
- å‰Šå¹³æµé‡å³°å€¼ï¼Œä¿æŠ¤æ•°æ®åº“

### 3. æ¶ˆæ¯ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ

**ç”Ÿäº§è€…**ï¼šå‘å¸ƒç¡®è®¤æœºåˆ¶ï¼ˆpublisher-confirmï¼‰
**Broker**ï¼šæŒä¹…åŒ–é˜Ÿåˆ— + é•œåƒé˜Ÿåˆ—
**æ¶ˆè´¹è€…**ï¼šæ‰‹åŠ¨ACK + æ­»ä¿¡é˜Ÿåˆ—å…œåº•

### 4. ä¸ºä»€ä¹ˆè¦ç”¨åˆ†å¸ƒå¼é”ï¼Ÿ

é˜²æ­¢åŒä¸€ç”¨æˆ·åœ¨é«˜å¹¶å‘ä¸‹é‡å¤ç§’æ€ã€‚è™½ç„¶æœ‰å”¯ä¸€ç´¢å¼•å…œåº•ï¼Œä½†åˆ†å¸ƒå¼é”å¯ä»¥å‡å°‘æ— æ•ˆè¯·æ±‚åˆ°æ•°æ®åº“ã€‚

### 5. Redissonåˆ†å¸ƒå¼é”çš„ä¼˜åŠ¿ï¼Ÿ

- å¯é‡å…¥é”
- çœ‹é—¨ç‹—è‡ªåŠ¨ç»­æœŸ
- çº¢é”æ”¯æŒï¼ˆå¤šèŠ‚ç‚¹ï¼‰
- å…¬å¹³é”æ”¯æŒ

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æœ¬åœ°ç¼“å­˜æ ‡è®°**ï¼šå†…å­˜ä¸­æ ‡è®°å·²å”®ç½„çš„æ´»åŠ¨ï¼Œå‡å°‘Redisè®¿é—®
2. **åˆ†æ®µé”**ï¼šå°†åº“å­˜æ‹†åˆ†ä¸ºå¤šä¸ªKeyï¼Œå‡å°‘é”ç«äº‰
3. **é¢„åˆ›å»ºè®¢å•**ï¼šæå‰ç”Ÿæˆè®¢å•å·ï¼Œå‡å°‘ç§’æ€æ—¶çš„è®¡ç®—
4. **å¤šçº§ç¼“å­˜**ï¼šæœ¬åœ°ç¼“å­˜ + Redisç¼“å­˜
5. **å¼‚æ­¥ä¸‹å•**ï¼šMQ + å›è°ƒé€šçŸ¥

## ğŸ“ License

MIT License

